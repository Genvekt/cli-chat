name: DB for auth service
on:
  push:
    branches:
      - main
      - dev
    paths:
      - 'services/auth/**'
      - 'services/auth/db/postgres/migrations/**'
  pull_request:
    branches:
      - main
      - dev
    paths:
      - 'services/auth/**'
      - 'services/auth/db/postgres/migrations/**'

env:
  DB_DIR: services/auth/db/postgres
  MIGRATOR_IMAGE: auth_migrator
  DOCKER_REGISTRY_URL: cr.selcloud.ru/genvekt-cli-chat

jobs:
  build-and-push:
    name: Build and Push migrator
    runs-on: ubuntu-20.04
    outputs:
      docker-tag: ${{ steps.meta.outputs.tag }}
    steps:
      - uses: actions/checkout@v3

      - name: Create .env file
        run: |
          touch ${{ env.DB_DIR }}/prod.env
          echo "${{ secrets.AUTH_POSTGRES_ENV_FILE }}" > ${{ env.DB_DIR }}/prod.env

      - name: Setup Docker Tag
        id: meta
        run: |
          echo "tag=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Setup Image names
        run: |
          echo "MIGRATOR_IMAGE=${{ env.DOCKER_REGISTRY_URL }}/${{ env.MIGRATOR_IMAGE }}:${{ steps.meta.outputs.tag }}" >> "$GITHUB_ENV"

      - name: Login to Registry
        uses: docker/login-action@v3
        with:
          registry: ${{env.DOCKER_REGISTRY_URL}}
          username: ${{secrets.DOCKER_REGISTRY_USERNAME}}
          password: ${{secrets.DOCKER_REGISTRY_PASSWORD}}

      - name: Build migrator
        run: |
          echo "${{env.MIGRATOR_IMAGE}}"
          docker-compose -f ${{ env.DB_DIR }}/docker-compose-prod.yaml build

      - name: Push to registry
        run: docker image push ${{ env.DOCKER_REGISTRY_URL }}/${{ env.MIGRATOR_IMAGE }}:${{ steps.meta.outputs.tag }}

      - name: Setup ssh key
        run: |
          touch key-file
          echo "${{secrets.SSH_KEY}}" >> key-file
          ssh-add key-file

      - name: Stop previous version
        run: DOCKER_HOST=“ssh://${{secrets.SSH_KEY}}@${{secrets.SSH_KEY}}” docker-compose  down --rmi all

      - name: Start new version
        run: DOCKER_HOST=“ssh://${{secrets.SSH_KEY}}@${{secrets.SSH_KEY}}” docker-compose up -d