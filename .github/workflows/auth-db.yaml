name: DB for auth service
on:
  push:
    branches:
      - main
      - dev
    paths:
      - 'services/auth/**'
      - 'services/auth/db/postgres/migrations/**'
  pull_request:
    branches:
      - main
      - dev
    paths:
      - 'services/auth/**'
      - 'services/auth/db/postgres/migrations/**'

env:
  DB_DIR: services/auth/db/postgres
  MIGRATOR_IMAGE_NAME: auth_migrator
  DOCKER_REGISTRY_URL: cr.selcloud.ru/genvekt-cli-chat

jobs:
  build-and-push:
    name: Build and Push migrator
    runs-on: ubuntu-20.04
    outputs:
      docker-tag: ${{ steps.meta.outputs.tag }}
    steps:
      - uses: actions/checkout@v3

      - name: Create prod.env file
        run: |
          touch ${{ env.DB_DIR }}/prod.env
          echo "${{ secrets.AUTH_POSTGRES_ENV_FILE }}" > ${{ env.DB_DIR }}/prod.env

      - name: Setup Docker Tag
        id: meta
        run: |
          echo "tag=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Setup Image names
        run: |
          echo "MIGRATOR_IMAGE=${{ env.DOCKER_REGISTRY_URL }}/${{ env.MIGRATOR_IMAGE_NAME }}:${{ steps.meta.outputs.tag }}" >> "$GITHUB_ENV"

      - name: Login to Registry
        uses: docker/login-action@v3
        with:
          registry: ${{env.DOCKER_REGISTRY_URL}}
          username: ${{secrets.DOCKER_REGISTRY_USERNAME}}
          password: ${{secrets.DOCKER_REGISTRY_PASSWORD}}

      - name: Build migrator
        run: |
          docker-compose -f ${{ env.DB_DIR }}/docker-compose.prod.yaml build

      - name: Push migrator to registry
        run: docker image push ${{ env.MIGRATOR_IMAGE }}

      - name: Create .env file
        run: |
          echo "Generating .env file"
          
          echo "# Autogenerated .env file" > .env
          echo "MIGRATOR_IMAGE=${{ env.MIGRATOR_IMAGE }}" >> .env

        # Copy docker-compose and .env files to target server
      - name: copy files to target server via scp
        uses: appleboy/scp-action@v0.1.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{secrets.SSH_USERNAME}}
          port: 22
          key: ${{secrets.SSH_KEY}}
          source: "${{ env.DB_DIR }}/docker-compose.prod.yaml,./.env,${{ env.DB_DIR }}/prod.env"
          target: "~/.deploy/auth/db/"

      - name: Run remote db migrations
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{secrets.SSH_USERNAME}}
          key: ${{secrets.SSH_KEY}}
          port: 22
          envs: APPTOKEN,USERNAME
          script: |
            # Login into Selectel Registry
            docker login -u ${{secrets.DOCKER_REGISTRY_USERNAME}} -p ${{secrets.DOCKER_REGISTRY_PASSWORD}} ${{env.DOCKER_REGISTRY_URL}}
            cd ~/.deploy/auth/db/
            docker compose -f ./docker-compose.prod.yml up -d